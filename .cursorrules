# MessageAI Agent Rules

## Quick Agent Commands

When you see a message like "cody pr-3" or "pete pr-5", automatically use the appropriate agent template:

### Agent Mapping:
- **cody** → Cody Agent (Building/Implementation)
- **pete** → Pete Agent (Planning/PRD Creation)  
- **brad** → Brad Agent (PR Brief Builder)

### Usage Pattern:
```
[agent-name] pr-[number]  OR  [agent-name] p[number]
```

**Both formats work:**
- `cody pr-3` or `cody p3` → Same result
- `pete pr-5` or `pete p5` → Same result  
- `brad pr-1` or `brad p1` → Same result

### Template Location:
Use the prompt from `MessageAI/agents/agent-prompt-template.md` under "General Agent Call" section, replacing:
- `[AGENT_NAME]` with the agent name (Cody, Pete, Brad)
- `[AGENT_ROLE]` with their role description
- `[agent-type]` with the agent type (cody, pete, brad)
- `[NUMBER]` with the PR number

### Examples:
- "cody pr-3" or "cody p3" → Cody agent for PR #3 implementation
- "pete pr-5" or "pete p5" → Pete agent for PR #5 planning
- "brad pr-1" or "brad p1" → Brad agent for PR #1 brief creation

Always reference the specific agent template file for detailed instructions.

---

# Swift Development Rules

Key Concepts for New Developers
Everything goes through the database - GRDB transactions are central
Dependency injection is preferred - Avoid global singletons when possible
Protocol-oriented - Heavy use of Swift protocols
Async/await everywhere - Modern Swift concurrency
Thread safety - Always consider which queue/thread you're on
Modular architecture - Clear layer separation (UI → SignalUI → SignalServiceKit)

## Project Context
- Swift 5.0
- Focus on main thread safety and responsive UI
- **Firebase Configuration**: All Firebase config files are located in `MessageAI/` directory:
  - `MessageAI/firebase.json` - Firebase project configuration
  - `MessageAI/firestore.indexes.json` - Firestore database indexes
  - `MessageAI/firestore.rules` - Firestore security rules
  - `MessageAI/storage.rules` - Firebase Storage security rules
  - `MessageAI/MessageAI/GoogleService-Info.plist` - iOS Firebase configuration

## Threading & Concurrency Rules

### Always Use Background Threads For:
- Network requests (URLSession, API calls)
- File I/O operations (reading/writing files)
- Database operations (Core Data, Realm, SQLite)
- Heavy computations or data processing
- Image processing or resizing
- JSON parsing of large data

### Always Use Main Thread For:
- Updating UI elements (labels, buttons, views)
- Presenting/dismissing view controllers
- Reloading table views or collection views
- Any UIKit or SwiftUI view updates

### Code Patterns to Follow:

**For async work returning to main thread:**
```swift
DispatchQueue.global(qos: .userInitiated).async {
    // Heavy work here
    let result = performExpensiveOperation()
    
    DispatchQueue.main.async {
        // Update UI here
        self.label.text = result
    }
}
```

**For network calls:**
```swift
URLSession.shared.dataTask(with: url) { data, response, error in
    // This is already on background thread
    guard let data = data else { return }
    
    // Parse data on background
    let parsed = parseData(data)
    
    // Switch to main for UI updates
    DispatchQueue.main.async {
        self.updateUI(with: parsed)
    }
}.resume()
```

## Code Review Checklist
- [ ] No network calls on main thread
- [ ] UI updates wrapped in `DispatchQueue.main.async`
- [ ] Heavy operations use background queues
- [ ] No synchronous file operations on main thread
- [ ] Table/collection view reloads on main thread

## Common Mistakes to Avoid
- Don't use `.sync` on main queue (causes deadlock)
- Don't forget to weakly capture `self` in closures: `[weak self]`
- Don't access UI elements from background threads
- Don't block main thread with `sleep()` or long loops

## Quality of Service (QoS) Guide
- `.userInteractive`: UI updates, animations (main thread)
- `.userInitiated`: User-requested tasks (e.g., loading data after tap)
- `.utility`: Long-running tasks with progress (downloads)
- `.background`: Non-urgent maintenance (cleanup, sync)
